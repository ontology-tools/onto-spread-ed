name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"

jobs:
  # ==========================================================================
  # Python Linting with Ruff
  # ==========================================================================
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1

      - name: Run ruff with reviewdog (all rules - warnings)
        if: github.event_name == 'pull_request'
        run: |
          uv run ruff check packages/ plugins/ --output-format=rdjson | \
            reviewdog -f=rdjson -name=ruff -reporter=github-pr-review -filter-mode=nofilter -level=warning
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run ruff check (errors only - for status)
        id: ruff_errors
        run: |
          uv run ruff check packages/ plugins/ --select=E,F --output-format=github
        continue-on-error: true

    outputs:
      failed: ${{ steps.ruff_errors.outcome == 'failure' }}

  # ==========================================================================
  # TypeScript/Vue Type Checking
  # ==========================================================================
  lint-typescript:
    name: Lint TypeScript/Vue
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1

      - name: Type check ose-js-core with reviewdog
        id: check_core
        if: github.event_name == 'pull_request'
        run: |
          npx vue-tsc -p packages/ose-js-core/tsconfig.app.json --noEmit 2>&1 | \
            reviewdog -efm="%f(%l,%c): error TS%n: %m" -name=vue-tsc-core -reporter=github-pr-review -filter-mode=nofilter -level=error
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Type check ose-js-core (for status)
        id: check_core_status
        run: npx vue-tsc -p packages/ose-js-core/tsconfig.app.json --noEmit
        continue-on-error: true

      - name: Type check ose-js-app with reviewdog
        id: check_app
        if: github.event_name == 'pull_request'
        run: |
          npx vue-tsc -p packages/ose-js-app/tsconfig.json --noEmit 2>&1 | \
            reviewdog -efm="%f(%l,%c): error TS%n: %m" -name=vue-tsc-app -reporter=github-pr-review -filter-mode=nofilter -level=error
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Type check ose-js-app (for status)
        id: check_app_status
        run: npx vue-tsc -p packages/ose-js-app/tsconfig.json --noEmit
        continue-on-error: true

      - name: Type check plugins with reviewdog
        if: github.event_name == 'pull_request'
        run: |
          for plugin in plugins/*/package.json; do
            dir=$(dirname "$plugin")
            if [ -f "$dir/tsconfig.json" ] || [ -f "$dir/tsconfig.app.json" ]; then
              echo "Type checking $dir..."
              tsconfig="$dir/tsconfig.app.json"
              [ ! -f "$tsconfig" ] && tsconfig="$dir/tsconfig.json"
              npx vue-tsc -p "$tsconfig" --noEmit 2>&1 | \
                reviewdog -efm="%f(%l,%c): error TS%n: %m" -name=vue-tsc-plugins -reporter=github-pr-review -filter-mode=nofilter -level=warning || true
            fi
          done
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

    outputs:
      failed: ${{ steps.check_core_status.outcome == 'failure' || steps.check_app_status.outcome == 'failure' }}

  # ==========================================================================
  # Check lint results (fail if any blocking errors)
  # ==========================================================================
  lint-results:
    name: Check Lint Results
    runs-on: ubuntu-latest
    needs: [lint-python, lint-typescript]
    if: always()

    steps:
      - name: Check for Python lint errors
        if: needs.lint-python.outputs.failed == 'true'
        run: |
          echo "::error::Python linting failed with errors"
          echo "LINT_FAILED=true" >> $GITHUB_ENV

      - name: Check for TypeScript errors
        if: needs.lint-typescript.outputs.failed == 'true'
        run: |
          echo "::error::TypeScript type checking failed with errors"
          echo "LINT_FAILED=true" >> $GITHUB_ENV

      - name: Fail if any lint errors
        if: needs.lint-python.outputs.failed == 'true' || needs.lint-typescript.outputs.failed == 'true'
        run: |
          echo "Linting failed. Please fix the errors above."
          exit 1

  # ==========================================================================
  # Build
  # ==========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-results]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install JS dependencies
        run: npm ci

      - name: Build JavaScript packages
        run: npm run build

      - name: Build CSS
        run: npm run build:css

      - name: Build Python packages
        run: |
          # Build all Python packages
          for pkg in packages/ose-core packages/ose-cli packages/ose-app; do
            echo "Building $pkg..."
            uv build --package $(basename $pkg)
          done
          # Build release plugins
          for plugin in plugins/ose-plugin-hierarchical-spreadsheets; do
            echo "Building $plugin..."
            uv build --package $(basename $plugin)
          done

      - name: Upload Python dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/*.tar.gz

      - name: Upload Python wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels
          path: dist/*.whl

  # ==========================================================================
  # Publish Python packages to PyPI (on release)
  # ==========================================================================
  publish-python:
    name: Publish Python to PyPI
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: pypi
      url: https://pypi.org/project/ose-core/
    permissions:
      id-token: write

    steps:
      - name: Download Python dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Download Python wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-wheels
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # ==========================================================================
  # Publish JS packages to npm (on release)
  # ==========================================================================
  publish-npm:
    name: Publish JS to npm
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: npm
      url: https://www.npmjs.com/package/@ose/js-core
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build JavaScript packages
        run: npm run build

      - name: Publish @ose/js-core to npm
        run: npm -w @ose/js-core publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==========================================================================
  # Deploy to development environment
  # ==========================================================================
  deploy-dev:
    name: Deploy to Development
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: development
      url: https://test.onto-ed.hbcptools.org/

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Download Python dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Download Python wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-wheels
          path: dist/

      - name: Create deployment package
        run: |
          tar -czf onto-ed.tar.gz dist/

      - name: Deploy app
        env:
          PRIVATE_KEY: ${{ secrets.deploymentKey }}
        run: |
          echo "$PRIVATE_KEY" | base64 --decode > privkey
          chmod 600 privkey
          mkdir -p "$HOME/.ssh"
          scp -o StrictHostKeyChecking=no -O -i privkey onto-ed.tar.gz "${{ secrets.deploymentUser }}@${{ secrets.deploymentHost }}:${{ secrets.deploymentPath }}"
          ssh -o StrictHostKeyChecking=no -i privkey "${{ secrets.deploymentUser }}@${{ secrets.deploymentHost }}" "sudo ./redeploy development"

  # ==========================================================================
  # Deploy to production environment
  # ==========================================================================
  deploy-prod:
    name: Deploy to Production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: hbcptools
      url: https://onto-ed.hbcptools.org/

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Download Python dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Download Python wheel artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-wheels
          path: dist/

      - name: Create deployment package
        run: |
          tar -czf onto-ed.tar.gz dist/

      - name: Deploy app
        env:
          PRIVATE_KEY: ${{ secrets.deploymentKey }}
        run: |
          echo "$PRIVATE_KEY" | base64 --decode > privkey
          chmod 600 privkey
          mkdir -p "$HOME/.ssh"
          scp -o StrictHostKeyChecking=no -O -i privkey onto-ed.tar.gz "${{ secrets.deploymentUser }}@${{ secrets.deploymentHost }}:${{ secrets.deploymentPath }}"
          ssh -o StrictHostKeyChecking=no -i privkey "${{ secrets.deploymentUser }}@${{ secrets.deploymentHost }}" "sudo ./redeploy hbcptools"
